# PreoccupyJS

<p align="center">
    <img src="https://github.com/iketari/preoccupyjs/raw/master/test-spa/src/assets/occupy_logo.png" alt="PrepoccupyJS's custom image"/>
</p>

[![styled with prettier](https://img.shields.io/badge/styled_with-prettier-ff69b4.svg)](https://github.com/prettier/prettier)
[![Travis](https://img.shields.io/travis/iketari/preoccupyjs.svg)](https://travis-ci.org/iketari/preoccupyjs)
[![Coveralls](https://img.shields.io/coveralls/iketari/preoccupyjs.svg)](https://coveralls.io/github/iketari/preoccupyjs)
[![Dev Dependencies](https://david-dm.org/iketari/preoccupyjs/dev-status.svg)](https://david-dm.org/iketari/preoccupyjs?type=dev)

An emulator of user behavioural actions for SPAs. Could be used as a part of Remote Control functionality.

### Demo

1. Open https://artsiom.mezin.eu/preoccupyjs/demo.
2. Click **Activate remote control**.
3. Click **Control** to open a new tab, it's going to open a new tab.
4. In the new tab click **Connect**. You will see a system dialog to choose the window to broadcast the screen media. Please, select the third tab with the title "Chrome Tab". From the options list select the tab with the title "PreoccupyJS. Test Application".
5. Enjoy!

### Docs

Docs: https://artsiom.mezin.eu/preoccupyjs/docs

### Coverage

HTML report: https://artsiom.mezin.eu/preoccupyjs/coverage/lcov-report/

### Architecture

The main idea of the PreoccupyJS package is to emulate users actions within a remote-controlled SPA and to change the SPA's DOM accordingly.

Under the hood PreoccupyJS consists of the next main parts:
1. [Host](http://artsiom.mezin.eu/preoccupyjs/docs/classes/host.html) - A controller for the host tab (machine), it's responsible for the collecting of Actions (user events) and transmitting it to the client tab using Transport.
2. [Client](http://artsiom.mezin.eu/preoccupyjs/docs/classes/client.html) - A controller for the client tab (machine), it's responsible for the Actions interpreting and performing on the client page.
3. [Actions](http://artsiom.mezin.eu/preoccupyjs/docs/classes/baseaction.html) - A quantum of information which is collected from the Host side. It describes a single user action (like click, mousemove, scroll, etc...). Each action is transmitted to the Client tab (machine) by the Transport and performed over there by the Client.
4. [Transport](http://artsiom.mezin.eu/preoccupyjs/docs/interfaces/abstracttransport.html) - An abstract class. A Transport implementation allows Actions to be transmitted from the host tab to the client one.

**PreoccupyJS doesn't provide a functionality to grab, broadcast, or present a Screen Media stream. You have to take care about this part of fuctionality separetly.**

### Basic Usage

Install from NPM

```bash
npm install --save-dev preoccupyjs
```

On the Host side:

1. Import the Host and required Transport constructors

```javascript
import { Host, RxjsTransport } from 'preoccupyjs';
```

2. Preapre a focusable DOM element, which is going to play a role of "touch screen" for the remote controller.

```javascript
const hostEl = document.createElement('div'); // fill free to style and modify this element as you wish, but don't delete it!

hostEl.tabIndex = 0; // make it focusable
```

3. Set up the transport

```javascript
const transport = new RxjsTransport(options as {
    subject: Subject<object>; // an AnonymousSubject, e.g. WebSocketSubject
    wrapFn?: (data: Message) => object; // wraps a preoccupyJS message to make it fits for your Subject type
});
```

4. Set up and run the host

```javascript
const host = new Host(transport, hostEl);

host.start(); // run the communication whenever your app is ready!
```

On the client side:

1. Import the Client, DomController, and required Transport constructors

```javascript
import { Host, RxjsTransport } from 'preoccupyjs';
```

2. Set up the transport

```javascript
const transport = new RxjsTransport(options as {
    subject: Subject<object>; // an AnonymousSubject, e.g. WebSocketSubject
    filterFn?: (rawMsg: object) => boolean; // filter all messages in subject to avoid non-preoccupyjs related
});
```

3. Set up and run the client

```javascript
const client = new Client(transport, new DomController(document.body)); // you can specify the controlled scope of the page by passing any other DOM element

client.start(); // run the communication whenever your app is ready!
```


### Features

 - Module structure. You can reuse existing Actions or replace/extend it by your own
 - Transport agnostic. It's up to you how to transmit the actions between host and client browser tabs

### Importing library

You can import the generated bundle to use the whole library generated by this starter:

```javascript
import { createHost, createClient } from 'preoccupyjs';
```

Additionally, you can import the transpiled modules (transports, actions) from `dist/lib`:

```javascript
import { DblClickToAction } from 'preoccupyjs/lib/actions/DblClickToAction';
```

### NPM scripts

 - `npm t`: Run test suite
 - `npm start`: Run `npm run build` in watch mode
 - `npm run test:watch`: Run test suite in [interactive watch mode](http://facebook.github.io/jest/docs/cli.html#watch)
 - `npm run test:prod`: Run linting and generate coverage
 - `npm run build`: Generate bundles and typings, create docs
 - `npm run lint`: Lints code
 - `npm run commit`: Commit using conventional commit style ([husky](https://github.com/typicode/husky) will tell you to use it if you haven't :wink:)

### Excluding peerDependencies

On library development, one might want to set some peer dependencies, and thus remove those from the final bundle. You can see in [Rollup docs](https://rollupjs.org/#peer-dependencies) how to do that.

Good news: the setup is here for you, you must only include the dependency name in `external` property within `rollup.config.js`. For example, if you want to exclude `lodash`, just write there `external: ['lodash']`.

### Automatic releases

_**Prerequisites**: you need to create/login accounts and add your project to:_
 - [npm](https://www.npmjs.com/)
 - [Travis CI](https://travis-ci.org)
 - [Coveralls](https://coveralls.io)

_**Prerequisite for Windows**: Semantic-release uses
**[node-gyp](https://github.com/nodejs/node-gyp)** so you will need to
install
[Microsoft's windows-build-tools](https://github.com/felixrieseberg/windows-build-tools)
using this command:_

```bash
npm install --global --production windows-build-tools
```

#### Setup steps

Follow the console instructions to install semantic release and run it (answer NO to "Do you want a `.travis.yml` file with semantic-release setup?").

_Note: make sure you've setup `repository.url` in your `package.json` file_

```bash
npm install -g semantic-release-cli
semantic-release-cli setup
# IMPORTANT!! Answer NO to "Do you want a `.travis.yml` file with semantic-release setup?" question. It is already prepared for you :P
```

From now on, you'll need to use `npm run commit`, which is a convenient way to create conventional commits.

Automatic releases are possible thanks to [semantic release](https://github.com/semantic-release/semantic-release), which publishes your code automatically on [github](https://github.com/) and [npm](https://www.npmjs.com/), plus generates automatically a changelog. This setup is highly influenced by [Kent C. Dodds course on egghead.io](https://egghead.io/courses/how-to-write-an-open-source-javascript-library)

### Git Hooks

There is already set a `precommit` hook for formatting your code with Prettier :nail_care:

By default, there are two disabled git hooks. They're set up when you run the `npm run semantic-release-prepare` script. They make sure:
 - You follow a [conventional commit message](https://github.com/conventional-changelog/conventional-changelog)
 - Your build is not going to fail in [Travis](https://travis-ci.org) (or your CI server), since it's runned locally before `git push`

This makes more sense in combination with [automatic releases](#automatic-releases)

### FAQ

#### `Array.prototype.from`, `Promise`, `Map`... is undefined?

TypeScript or Babel only provides down-emits on syntactical features (`class`, `let`, `async/await`...), but not on functional features (`Array.prototype.find`, `Set`, `Promise`...), . For that, you need Polyfills, such as [`core-js`](https://github.com/zloirock/core-js) or [`babel-polyfill`](https://babeljs.io/docs/usage/polyfill/) (which extends `core-js`).

For a library, `core-js` plays very nicely, since you can import just the polyfills you need:

```javascript
import "core-js/fn/array/find"
import "core-js/fn/string/includes"
import "core-js/fn/promise"
...
```

Contributions of any kind are welcome!